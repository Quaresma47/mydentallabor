<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>STL Önizleyici - MyDentalLabor</title>
  <style>
    body, html { margin:0; height:100%; background:#071021; color:#fff }
    #viewer { width:100%; height:100vh; display:block }
    .topbar { position: absolute; left:10px; top:10px; z-index:10 }
    .topbar button { margin-right:8px }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="backBtn">Geri</button>
    <button id="fitBtn">Fit</button>
  </div>
  <div id="viewer"></div>

  <!-- Three.js via CDN -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/STLLoader.js"></script>

  <script>
    // Viewer setup
    const container = document.getElementById('viewer');
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x071021);
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,0,100);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0,0,1).normalize();
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    let mesh;

    function fitToView(object){
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());
      controls.reset();
      object.position.x += (object.position.x - center.x);
      object.position.y += (object.position.y - center.y);
      const dist = size * 1.5;
      camera.position.set(center.x, center.y, dist);
      controls.update();
    }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Receive file via postMessage from filesend page using window.name technique or localStorage
    // We'll read from sessionStorage key 'stlFile' which will contain an object URL created on filesend page
    window.addEventListener('DOMContentLoaded', () => {
  // 1️⃣ Önce sessionStorage kontrolü
  const sessionUrl = sessionStorage.getItem('stlObjectUrl');
  if (sessionUrl) {
    loadUrl(sessionUrl);
    return;
  }

  // 2️⃣ Eğer yoksa URL parametresinden dosya adını al
  const urlParams = new URLSearchParams(window.location.search);
  const fileName = urlParams.get('file');
  if (fileName) {
    const fullUrl = `https://mydentallabor-files.s3.eu-central-1.amazonaws.com/uploads/${fileName}`;

    return;
  }

  // 3️⃣ Hiçbiri yoksa kullanıcıya bilgi ver
  const el = document.createElement('div');
  el.style.position = 'absolute';
  el.style.left = '50%';
  el.style.top = '50%';
  el.style.transform = 'translate(-50%,-50%)';
  el.style.background = 'rgba(0,0,0,0.6)';
  el.style.padding = '24px';
  el.style.borderRadius = '8px';
  el.innerHTML = '<strong>Önizleme için dosya seçip sonra "Önizle" butonuna basın.</strong>';
  document.body.appendChild(el);
});

    function loadUrl(url){
    const loader = new THREE.STLLoader();
    loader.load(url, function(geometry){
      if(mesh) scene.remove(mesh);

      const material = new THREE.MeshPhongMaterial({
        color: 0xdddddd,
        specular: 0x111111,
        shininess: 200
      });

      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      fitToView(mesh);
    }, undefined, function(err){
      console.error('STL yükleme hatası:', err);
      alert('Dosya yüklenirken bir hata oluştu. Lütfen dosya adını ve yolu kontrol edin.');
    });
  }

    document.getElementById('backBtn').addEventListener('click', ()=>{ window.history.back(); });
    document.getElementById('fitBtn').addEventListener('click', ()=>{ if(mesh) fitToView(mesh); });

    // listen for messages from opener if window was opened via window.open
    window.addEventListener('message', (e)=>{
      if(e.data && e.data.type === 'stl-url'){
        loadUrl(e.data.url);
      }
    });

    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
